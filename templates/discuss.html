{% extends 'base.html' %}

{% block header_content %}

<script src="{{ url_for('static', filename='marked.min.js') }}"></script>

<style>
	div.comment-section {
		margin-left: -50px;
	}
	div.comment-group {
		margin-left: 50px;
		padding-left: 10px;
		border-left-style: dashed;
		border-left-color: pink;
	}
	div.comment-submit {
		display: inline;
	}
	div.comment-children {
		display: inline;
	}
	.table
	{
		width:50px;
	}
	.comment-form
	{
		display:none;
	}
	tr.title
	{
		background-color:pink;
	}
	.comment-scroll
	{
		float:left;
	}
	#comments
	{
		display:none;
	}
</style>

<script>
// passed in from flask as json
var tweets = {{ tweets | tojson }};
var papers = {{ papers | tojson }};
var render_format = "{{ render_format }}";
var username = "{{ g.user.username }}";
var msg = "{{ msg }}";


var cid_highlight;
var node_scroll_to;
	
//Render post preview.
var prev_txt = '';
function renderPost() {
  var txt = $("#post-text").val(); // raw text of textarea contents
  if(txt === prev_txt) { return; } // break out early, no changes from before.
  prev_txt = txt;

  console.log('rendering preview...');
  $("#preview-wrap").slideDown("fast");

  // render to html with marked
  var html = marked(txt);
  // insert into preview div
  $("#preview").html(html);
  // fire off a request to process any latex
  if (typeof MathJax !== 'undefined') { MathJax.Hub.Queue(["Typeset",MathJax.Hub]); }
}

function add_submit_btn(elm, event) {
	var id = event.target.id;
	$('.comment-submit').find('#'+id).slideToggle("fast", function() { });
}

function close_children_btn(elm, event) {
	var id = event.target.id;
	$('.comment-children').find('#'+id).slideToggle("fast", function() { });
}

function scroll_btn(elm, event) {
	var id = event.target.id;
	$('.comment').find('#'+id).focus();
}

function toggle_it(elm)
{
	var element =  $(elm).closest('.comment-group')
			.find('#comments')
	element.toggle('fast');
}

// when page loads...
$(document).ready(function(){

	cid_highlight = QueryString.cid;

	// display message, if any
	if(msg !== '') { d3.select("#rtable").append('div').classed('msg', true).html(msg); }
	// display the subject-of-disussion paper on top
	addPapers(1, false);


	// click on Pitch in! call for action toggle expansion of comment textarea etc
	$("#pitchin-cfa").click(function() {
		$("#pitchin").slideToggle("fast", function() { });
	});
  
	$('.toggling').click(function() {
		toggle_it(this);
	})
	
	$('div.comment-scroll').click(function(event) {
		var group = $(this).closest('.comment-group'),
				nextgroup = group.parent().closest('.comment-group');
		if (nextgroup.length) {
			group = nextgroup;
		}
		$('html, body').animate({
			scrollTop: group.offset().top + 'px',
		});
	});
  
	// periodically try to render a preview of the post 
	// TODO: only do if comment box open
	setInterval(renderPost, 250);

	// scroll to a comment if any
	if(typeof node_scroll_to !== 'undefined') {
		$('html, body').animate({
			scrollTop: $(node_scroll_to).offset().top
		}, 1000);
	}
	
	$('div.comment-reply button').click(function(event) {
		add_submit_btn(this, event);
    });
	
	$('div.comment-scroll button').click(function(event) {
		scroll_btn(this, event);
    });
	
	$('div.comment-close-children button').click(function(event) {
		close_children_btn(this, event);
    });
});

</script>

{% endblock %}


{% macro render_comment_box(id, gpid, level) -%}

	<!-- functionality to add new comments -->
	<form action="{{ url_for('comment') }}" method="post" {% if level > 0 %} class="comment-form" id="{{id}}" {% endif %} >
		<div>
			<div class="piitemdo">- <b>DO</b>: Add helpful links to code, project page, or related discussion.</div>
			<div class="piitemdo">- <b>DO</b>: Offer <u>constructive</u> comments on this work.</div>
			<div class="piitemdo">- <b>DON'T</b>: Post generic comments of little value, e.g. "this is great.", "nice", etc.</div>
			<div class="piitemdo">- <b>DON'T</b>: Troll, call people names, be disrespectful. Pretty please.</div>
		</div>
		<!-- form for submitting a new discussion -->
		<div style="border-top:1px solid black; margin-top:5px; padding-top:5px;">
			<textarea name="text" id="post-text" rows="15" style="width: 98.5%;font-size: 16px;padding: 6px 6px;color: #333;line-height1.42857143:;border: 1px solid #ccc;box-shadow: inset 0 1px 1px rgba(0,0,0,.075);overflow: auto;border-radius: 4px;margin-top: 4px;"></textarea>
			<div style="color:#555">(You can use $\LaTeX$ and markdown)</div>
		</div>
		{% if level > 0 %}
		<input type="hidden" name="parent_id" value="{{ id }}" />
		{% endif %}
		<input type="hidden" name="pid" value="{{ gpid }}" />
		<br>
		<div id="preview-wrap" style="display:none; margin-bottom:5px;">
			<div style="margin-top: 5px;padding-top: 5px;font-size: 20px;">Live preview:</div>
			<div id="preview" style="background-color: #fff;padding: 5px;border: 1px solid #999;"></div>
		</div>
		<br>
		<div style="background-color: #eee; padding:5px;">
			On this paper's topic, I am:
			<input type="radio" name="conf" value="expert"> expert
			<input type="radio" name="conf" value="confident"> confident
			<input type="radio" name="conf" value="uncertain" checked="checked"> uncertain
			<br>
			<input type="checkbox" name="anon" value="anon"> Post anonymously
		</div>
		<div><button id="btnpost" style="margin-top:5px;" class="ppbutton" type="submit">Post</button></div>
	</form>

{%- endmacro %}

{% macro render_comment(comment, level=0) -%}
<!-- Comment scroll -->	
<div class="comment" id="{{comment._id}}">
	<div class="caction">
		<a href="discuss?id={{comment.gpid}}&cid={{ comment._id }}">
			<img src="static/linkto.png" alt="link to this comment">
		</a>
	</div>
	<div class="cheader">
		<div class="cuser">@{{ comment.user }}</div>
		<div class="ctime">{{ comment.time_posted | ctime }}</div>
		<div class="cver">v{{ comment.version }}</div>
		<div class="cconf">{{ comment.conf }}</div>
	</div>
	<div class="ctext">
		{{ comment.text|markdownify|safe }}
	</div>
	<div class="ctags">
		{% for i in range(comment.tags|length) %}
			<div class="ctag-count {% if comment.tag_counts[i] == 0 %}ctag-count-zero{% endif %} ">
				{{comment.tag_counts[i]}}
			</div>
			<form action="/toggletag" method="post" class="ctag">
				<input type="hidden" name="comment_id" value="{{ comment._id }}" />
				<input type="hidden" name="pid" value="{{ gpid }}" />
				<input type="hidden" name="tag_name" value="{{ comment.tags[i] }}" />
				<button type="submit" class="ctag">{{ comment.tags[i] }}</button>
			</form>
		{% endfor %}
		
		<!-- Reply -->
		{% if level %}
		<div class="comment-scroll" style="display:inline-block; float: right;" >
			<button id={{comment.parent}} class="button-primary" >Scroll to parent</button>
		</div>
		{% endif %}
		{% if comment.children|length > 0 %}
		<div class="comment-close-children" style="display:inline-block; float: right;">
			<button id={{comment._id}} class="btn-primary comment-close-children">Toggle Children</button>
		</div>
		{% endif %}
		<div class="comment-reply" style="display:inline-block; float: right;">
			<button id={{comment._id}} class="btn-primary comment-reply">Reply</button>
		</div>
	</div>
	<div class="cerr"></div>
	
	<!-- Textarea and submit -->
	<div class="comment-submit" id={{comment._id}}>
		{{ render_comment_box(comment._id , gpid, level+1) }}
	</div>	

	<!-- Render children -->
	<div class="comment-children" id="{{comment._id}}">
		<ul>
			{% for child in comment.children %}
				<li>
					{{ render_comment(child, level + 1) }}
				</li>
			{% if loop.last and comment.children|length > 2 %}
			</div>
			<button type="button" class="toggling"> show/hide replies </button>
			{% endif %}
		{% endfor %}
		</ul>
	</div>
</div>


{%- endmacro %}


{% block content %}

<div id="maindiv">
  <!-- contains the paper of interest -->
  <div id="rtable" style="margin-top:40px;"></div>
  <!-- functionality to add new comments -->
  <div id="pitchin-cfa" style="background-color:#d7e5ff; padding: 10px; margin-top: 5px; border: 1px solid #b7c5e0; cursor: pointer;">Pitch in!</div>
  <div id="pitchin" style="padding: 5px 5px 10px 5px; border-radius: 0px 0px 5px 5px; display: none;">
    {{ render_comment_box("", gpid, 0) }}
  </div>

  <!-- contains the discussion -->
  <div id="discussion">
    <div style="padding:5px; margin-top:10px; font-size:20px;">Discussion:</div>
	<div class="comment-section">
		{%  if comments|length ==0 %}
			<p> Nothing here yet. </p>
		{% else %}
			<ul>
			{% for comment in comments %}
				 <li>
				{{ render_comment(comment) }}
				</li>
			{% endfor %}
		{% endif %}
		</ul>
    </div>
  </div>
</div>

{% endblock %}
